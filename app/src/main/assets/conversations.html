<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¯¹è¯åˆ—è¡¨ - å°å¤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .header .subtitle {
            font-size: 12px;
            opacity: 0.8;
        }

        .actions {
            display: flex;
            justify-content: space-between;
            padding: 12px 16px;
            background: white;
            border-bottom: 1px solid #eee;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #f0f2f5;
            color: #333;
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f2f5;
            border: none;
            cursor: pointer;
        }

        .conversation-list {
            padding: 8px;
        }

        .conversation-item {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.3s;
        }

        .conversation-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .conversation-item.selected {
            border-left: 4px solid #667eea;
            background: #f8f9ff;
        }

        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .conversation-title {
            font-weight: 600;
            font-size: 16px;
            color: #333;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conversation-time {
            font-size: 12px;
            color: #999;
            margin-left: 8px;
        }

        .conversation-summary {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .conversation-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            font-size: 12px;
            color: #999;
        }

        .conversation-count {
            background: #f0f2f5;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .conversation-status {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        .conversation-status.active {
            background: #e7f7e9;
            color: #27ae60;
        }

        .conversation-status.expired {
            background: #fee;
            color: #e74c3c;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            color: #999;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f0f2f5;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .error-state {
            text-align: center;
            padding: 40px 20px;
            color: #e74c3c;
        }

        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 1000;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .context-menu {
            position: absolute;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            min-width: 160px;
            z-index: 1000;
            overflow: hidden;
        }

        .context-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .context-menu-item:hover {
            background: #f5f5f5;
        }

        .context-menu-item.delete {
            color: #e74c3c;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 90%;
            width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
        }
    </style>
</head>
<body>
<div class="header">
    <h1>æˆ‘çš„å¯¹è¯</h1>
    <div class="subtitle" id="sessionInfo">æ­£åœ¨åŠ è½½...</div>
</div>

<div class="actions">
    <button class="btn btn-secondary" onclick="refreshConversations()">
        åˆ·æ–°
    </button>
    <button class="btn btn-primary" onclick="createNewChat()">
        æ–°å¯¹è¯
    </button>
</div>

<div class="conversation-list" id="conversationList">
    <!-- å¯¹è¯åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€æ’å…¥ -->
</div>

<button class="fab" onclick="createNewChat()">
    <span>+</span>
</button>

<!-- åŠ è½½çŠ¶æ€ -->
<div id="loadingState" class="loading" style="display: none;">
    <div class="spinner"></div>
    <div>åŠ è½½ä¸­...</div>
</div>

<!-- ç©ºçŠ¶æ€ -->
<div id="emptyState" class="empty-state" style="display: none;">
    <div class="empty-icon">ğŸ’¬</div>
    <h3>æš‚æ— å¯¹è¯</h3>
    <p>å¼€å§‹ä¸€ä¸ªæ–°çš„å¯¹è¯å§ï¼</p>
</div>

<!-- é”™è¯¯çŠ¶æ€ -->
<div id="errorState" class="error-state" style="display: none;">
    <div>åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>
    <button class="btn btn-secondary" onclick="refreshConversations()" style="margin-top: 12px;">
        é‡è¯•
    </button>
</div>

<!-- ä¸Šä¸‹æ–‡èœå• -->
<div id="contextMenu" class="context-menu" style="display: none;"></div>

<!-- ç¡®è®¤åˆ é™¤å¯¹è¯æ¡† -->
<div id="deleteModal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">åˆ é™¤å¯¹è¯</h3>
            <p>ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚</p>
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeDeleteModal()">
                å–æ¶ˆ
            </button>
            <button class="btn btn-primary" onclick="confirmDelete()" style="background: #e74c3c;">
                åˆ é™¤
            </button>
        </div>
    </div>
</div>

<script>
    // å…¨å±€çŠ¶æ€
    let conversations = [];
    let selectedConversationId = null;
    let currentPage = 0;
    let pageSize = 20;
    let hasMore = true;
    let isLoading = false;
    let deleteTargetId = null;

    // é…ç½®
    const API_BASE_URL = window.APP_CONFIG?.baseUrl || "https://derbi.net.cn";
    const SESSION_ID = window.APP_CONFIG?.sessionId || "";

    // DOMå…ƒç´ 
    const conversationList = document.getElementById('conversationList');
    const loadingState = document.getElementById('loadingState');
    const emptyState = document.getElementById('emptyState');
    const errorState = document.getElementById('errorState');
    const sessionInfo = document.getElementById('sessionInfo');
    const contextMenu = document.getElementById('contextMenu');
    const deleteModal = document.getElementById('deleteModal');

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        initSession();
        loadConversations();
        setupEventListeners();
    });

    // åˆå§‹åŒ–ä¼šè¯
    async function initSession() {
        try {
            // ä»Androidè·å–sessionId
            const sessionId = window.Android?.getSessionId() || SESSION_ID;
            if (!sessionId) {
                // å¦‚æœæ²¡æœ‰sessionIdï¼Œåˆå§‹åŒ–æ–°çš„
                const response = await fetch(`${API_BASE_URL}/api/session/init`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: "user_" + Date.now()
                    })
                });

                const data = await response.json();
                const newSessionId = data.sessionId || response.headers.get('X-Session-Id');

                if (newSessionId) {
                    window.Android?.saveSessionId(newSessionId);
                    updateSessionInfo(newSessionId);
                }
            } else {
                updateSessionInfo(sessionId);
            }
        } catch (error) {
            console.error('åˆå§‹åŒ–ä¼šè¯å¤±è´¥:', error);
            sessionInfo.textContent = 'ä¼šè¯åˆå§‹åŒ–å¤±è´¥';
        }
    }

    // æ›´æ–°ä¼šè¯ä¿¡æ¯æ˜¾ç¤º
    function updateSessionInfo(sessionId) {
        const shortId = sessionId.substring(0, 8) + '...';
        sessionInfo.textContent = `ä¼šè¯ID: ${shortId}`;
    }

    // åŠ è½½å¯¹è¯åˆ—è¡¨
    async function loadConversations() {
        if (isLoading || !hasMore) return;

        showLoading();
        isLoading = true;

        try {
            const sessionId = window.Android?.getSessionId() || SESSION_ID;
            const response = await fetch(
                `${API_BASE_URL}/api/sessions?page=${currentPage}&pageSize=${pageSize}`,
                {
                    headers: {
                        'X-Session-Id': sessionId
                    }
                }
            );

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();

            if (data.sessions && data.sessions.length > 0) {
                conversations = [...conversations, ...data.sessions];
                renderConversations();

                // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤š
                hasMore = data.sessions.length >= pageSize;
                if (hasMore) {
                    currentPage++;
                }
            } else {
                if (conversations.length === 0) {
                    showEmptyState();
                }
                hasMore = false;
            }

            hideLoading();
        } catch (error) {
            console.error('åŠ è½½å¯¹è¯åˆ—è¡¨å¤±è´¥:', error);
            showErrorState();
        } finally {
            isLoading = false;
        }
    }

    // æ¸²æŸ“å¯¹è¯åˆ—è¡¨
    function renderConversations() {
        if (conversations.length === 0) {
            showEmptyState();
            return;
        }

        hideAllStates();

        conversationList.innerHTML = conversations.map(conversation => `
            <div class="conversation-item ${selectedConversationId === conversation.id ? 'selected' : ''}"
                 data-id="${conversation.id}"
                 onclick="openConversation('${conversation.id}')"
                 oncontextmenu="showContextMenu(event, '${conversation.id}'); return false;">

                <div class="conversation-header">
                    <div class="conversation-title" title="${escapeHtml(conversation.title)}">
                        ${escapeHtml(conversation.title)}
                    </div>
                    <div class="conversation-time">
                        ${formatTime(conversation.updatedAt)}
                    </div>
                </div>

                <div class="conversation-summary" title="${escapeHtml(conversation.summary)}">
                    ${escapeHtml(conversation.summary)}
                </div>

                <div class="conversation-meta">
                    <div class="conversation-count">
                        ${conversation.messageCount || 0} æ¡æ¶ˆæ¯
                    </div>
                    <div class="conversation-status ${conversation.isExpired ? 'expired' : 'active'}">
                        ${conversation.isExpired ? 'å·²è¿‡æœŸ' : 'æ´»è·ƒ'}
                    </div>
                </div>
            </div>
        `).join('');
    }

    // æ‰“å¼€å¯¹è¯
    function openConversation(conversationId) {
        selectedConversationId = conversationId;

        // è°ƒç”¨Androidæ¥å£æ‰“å¼€èŠå¤©é¡µé¢
        window.Android?.openChat(conversationId);

        // æ›´æ–°é€‰ä¸­çŠ¶æ€
        renderConversations();
    }

    // åˆ›å»ºæ–°å¯¹è¯
    async function createNewChat() {
        try {
            // æ¸…é™¤å½“å‰ä¼šè¯
            window.Android?.clearSession();

            // åˆå§‹åŒ–æ–°ä¼šè¯
            await initSession();

            // æ‰“å¼€èŠå¤©é¡µé¢
            window.Android?.openChat('new');

        } catch (error) {
            console.error('åˆ›å»ºæ–°å¯¹è¯å¤±è´¥:', error);
            window.Android?.showToast('åˆ›å»ºæ–°å¯¹è¯å¤±è´¥');
        }
    }

    // åˆ·æ–°å¯¹è¯åˆ—è¡¨
    function refreshConversations() {
        conversations = [];
        currentPage = 0;
        hasMore = true;
        loadConversations();
    }

    // æ˜¾ç¤ºä¸Šä¸‹æ–‡èœå•
    function showContextMenu(event, conversationId) {
        event.preventDefault();

        // è®¾ç½®èœå•ä½ç½®
        contextMenu.style.left = event.clientX + 'px';
        contextMenu.style.top = event.clientY + 'px';
        contextMenu.style.display = 'block';

        // åˆ›å»ºèœå•é¡¹
        contextMenu.innerHTML = `
            <div class="context-menu-item" onclick="loadToCache('${conversationId}'); hideContextMenu()">
                åŠ è½½åˆ°ç¼“å­˜
            </div>
            <div class="context-menu-item" onclick="renameConversation('${conversationId}'); hideContextMenu()">
                é‡å‘½å
            </div>
            <div class="context-menu-item delete" onclick="showDeleteModal('${conversationId}'); hideContextMenu()">
                åˆ é™¤
            </div>
        `;

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—èœå•
        setTimeout(() => {
            document.addEventListener('click', hideContextMenu, { once: true });
        }, 100);
    }

    // éšè—ä¸Šä¸‹æ–‡èœå•
    function hideContextMenu() {
        contextMenu.style.display = 'none';
    }

    // åŠ è½½å¯¹è¯åˆ°ç¼“å­˜
    async function loadToCache(conversationId) {
        try {
            const sessionId = window.Android?.getSessionId() || SESSION_ID;
            const response = await fetch(
                `${API_BASE_URL}/api/session/${conversationId}/load-cache`,
                {
                    method: 'POST',
                    headers: {
                        'X-Session-Id': sessionId
                    }
                }
            );

            if (response.ok) {
                window.Android?.showToast('å·²åŠ è½½åˆ°ç¼“å­˜');
            } else {
                throw new Error('åŠ è½½å¤±è´¥');
            }
        } catch (error) {
            console.error('åŠ è½½åˆ°ç¼“å­˜å¤±è´¥:', error);
            window.Android?.showToast('åŠ è½½å¤±è´¥');
        }
    }

    // é‡å‘½åå¯¹è¯
    async function renameConversation(conversationId) {
        const conversation = conversations.find(c => c.id === conversationId);
        if (!conversation) return;

        const newTitle = prompt('è¯·è¾“å…¥æ–°çš„æ ‡é¢˜', conversation.title);
        if (newTitle && newTitle.trim()) {
            try {
                const sessionId = window.Android?.getSessionId() || SESSION_ID;
                const response = await fetch(
                    `${API_BASE_URL}/api/session/${conversationId}/rename`,
                    {
                        method: 'POST',
                        headers: {
                            'X-Session-Id': sessionId,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            title: newTitle.trim()
                        })
                    }
                );

                if (response.ok) {
                    // æ›´æ–°æœ¬åœ°æ•°æ®
                    conversation.title = newTitle.trim();
                    renderConversations();
                    window.Android?.showToast('é‡å‘½åæˆåŠŸ');
                } else {
                    throw new Error('é‡å‘½åå¤±è´¥');
                }
            } catch (error) {
                console.error('é‡å‘½åå¤±è´¥:', error);
                window.Android?.showToast('é‡å‘½åå¤±è´¥');
            }
        }
    }

    // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
    function showDeleteModal(conversationId) {
        deleteTargetId = conversationId;
        deleteModal.style.display = 'flex';
    }

    // å…³é—­åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
    function closeDeleteModal() {
        deleteModal.style.display = 'none';
        deleteTargetId = null;
    }

    // ç¡®è®¤åˆ é™¤
    async function confirmDelete() {
        if (!deleteTargetId) return;

        try {
            const sessionId = window.Android?.getSessionId() || SESSION_ID;
            const response = await fetch(
                `${API_BASE_URL}/api/session/${deleteTargetId}`,
                {
                    method: 'DELETE',
                    headers: {
                        'X-Session-Id': sessionId
                    }
                }
            );

            if (response.ok) {
                // ä»åˆ—è¡¨ä¸­ç§»é™¤
                conversations = conversations.filter(c => c.id !== deleteTargetId);
                renderConversations();
                window.Android?.showToast('åˆ é™¤æˆåŠŸ');
            } else {
                throw new Error('åˆ é™¤å¤±è´¥');
            }
        } catch (error) {
            console.error('åˆ é™¤å¤±è´¥:', error);
            window.Android?.showToast('åˆ é™¤å¤±è´¥');
        } finally {
            closeDeleteModal();
        }
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    function showLoading() {
        hideAllStates();
        loadingState.style.display = 'flex';
    }

    // éšè—åŠ è½½çŠ¶æ€
    function hideLoading() {
        loadingState.style.display = 'none';
    }

    // æ˜¾ç¤ºç©ºçŠ¶æ€
    function showEmptyState() {
        hideAllStates();
        emptyState.style.display = 'block';
    }

    // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
    function showErrorState() {
        hideAllStates();
        errorState.style.display = 'block';
    }

    // éšè—æ‰€æœ‰çŠ¶æ€
    function hideAllStates() {
        loadingState.style.display = 'none';
        emptyState.style.display = 'none';
        errorState.style.display = 'none';
        conversationList.style.display = 'block';
    }

    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    function setupEventListeners() {
        // æ»šåŠ¨åŠ è½½æ›´å¤š
        window.addEventListener('scroll', function() {
            const scrollTop = document.documentElement.scrollTop;
            const scrollHeight = document.documentElement.scrollHeight;
            const clientHeight = document.documentElement.clientHeight;

            if (scrollTop + clientHeight >= scrollHeight - 100) {
                loadConversations();
            }
        });

        // ESCé”®å…³é—­èœå•å’Œæ¨¡æ€æ¡†
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                hideContextMenu();
                closeDeleteModal();
            }
        });
    }

    // å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¶é—´
    function formatTime(timestamp) {
        if (!timestamp) return 'æœªçŸ¥æ—¶é—´';

        const date = new Date(timestamp);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMins / 60);
        const diffDays = Math.floor(diffHours / 24);

        if (diffMins < 1) return 'åˆšåˆš';
        if (diffMins < 60) return `${diffMins}åˆ†é’Ÿå‰`;
        if (diffHours < 24) return `${diffHours}å°æ—¶å‰`;
        if (diffDays < 7) return `${diffDays}å¤©å‰`;

        return date.toLocaleDateString('zh-CN', {
            month: 'short',
            day: 'numeric'
        });
    }

    // å·¥å…·å‡½æ•°ï¼šHTMLè½¬ä¹‰
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // æš´éœ²å…¨å±€å‡½æ•°ä¾›Androidè°ƒç”¨
    window.refreshConversations = refreshConversations;
    window.createNewChat = createNewChat;
    window.openConversation = openConversation;
</script>
</body>
</html>